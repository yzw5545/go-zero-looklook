# 服务启动命令汇总

## 前提条件

确保 MySQL 和 Redis 已经启动：
```bash
# 查看 MySQL 状态（端口 33069）
lsof -i :33069

# 查看 Redis 状态（端口 36379）
lsof -i :36379
```

## 一、只需要 MySQL + Redis 的服务

### 1. Usercenter 用户中心

```bash
# 终端1：启动 usercenter-rpc
go run app/usercenter/cmd/rpc/usercenter.go -f app/usercenter/cmd/rpc/etc/usercenter.yaml

# 终端2：启动 usercenter-api
go run app/usercenter/cmd/api/usercenter.go -f app/usercenter/cmd/api/etc/usercenter.yaml
```

**端口：**
- API: 1004
- RPC: 2004
- Prometheus: 4008(api), 4009(rpc)

**访问测试：**
```bash
# 登录接口
curl -X POST http://localhost:1004/user/login \
  -H "Content-Type: application/json" \
  -d '{"mobile":"13800138000","password":"123456"}'

# 修改密码接口
./test_change_password.sh
```

---

### 2. Travel 旅游/民宿

```bash
# 终端3：启动 travel-rpc
go run app/travel/cmd/rpc/travel.go -f app/travel/cmd/rpc/etc/travel.yaml

# 终端4：启动 travel-api
go run app/travel/cmd/api/travel.go -f app/travel/cmd/api/etc/travel.yaml
```

**端口：**
- API: 1003
- RPC: 2003

---

### 3. Payment 支付

```bash
# 终端5：启动 payment-rpc
go run app/payment/cmd/rpc/payment.go -f app/payment/cmd/rpc/etc/payment.yaml

# 终端6：启动 payment-api
go run app/payment/cmd/api/payment.go -f app/payment/cmd/api/etc/payment.yaml
```

**端口：**
- API: 1002
- RPC: 2002

---

### 4. Order 订单（API 和 RPC）

```bash
# 终端7：启动 order-rpc
go run app/order/cmd/rpc/order.go -f app/order/cmd/rpc/etc/order.yaml

# 终端8：启动 order-api
go run app/order/cmd/api/order.go -f app/order/cmd/api/etc/order.yaml
```

**端口：**
- API: 1001
- RPC: 2001

---

## 二、需要 Kafka 的服务（可选）

### 5. Order MQ 消息队列消费者

⚠️ **依赖：需要 Kafka 运行在 kafka:9092**

```bash
# 终端9：启动 order-mq
go run app/order/cmd/mq/order.go -f app/order/cmd/mq/etc/order.yaml
```

**端口：**
- Prometheus: 4003

---

### 6. Mqueue 任务队列

⚠️ **依赖：需要 Kafka**

```bash
# 终端10：启动 mqueue-scheduler
go run app/mqueue/cmd/scheduler/mqueue.go -f app/mqueue/cmd/scheduler/etc/mqueue.yaml

# 终端11：启动 mqueue-job
go run app/mqueue/cmd/job/mqueue.go -f app/mqueue/cmd/job/etc/mqueue.yaml
```

**端口：**
- Scheduler: 3003
- Job: 3002

---

## 编译版本启动（更快）

如果不需要热加载，可以先编译后启动：

```bash
# 编译所有服务
mkdir -p data/server

# Usercenter
go build -o data/server/usercenter-rpc -v app/usercenter/cmd/rpc/usercenter.go
go build -o data/server/usercenter-api -v app/usercenter/cmd/api/usercenter.go

# Travel
go build -o data/server/travel-rpc -v app/travel/cmd/rpc/travel.go
go build -o data/server/travel-api -v app/travel/cmd/api/travel.go

# Payment
go build -o data/server/payment-rpc -v app/payment/cmd/rpc/payment.go
go build -o data/server/payment-api -v app/payment/cmd/api/payment.go

# Order
go build -o data/server/order-rpc -v app/order/cmd/rpc/order.go
go build -o data/server/order-api -v app/order/cmd/api/order.go
go build -o data/server/order-mq -v app/order/cmd/mq/order.go

# 启动编译后的服务
./data/server/usercenter-rpc -f app/usercenter/cmd/rpc/etc/usercenter.yaml
./data/server/usercenter-api -f app/usercenter/cmd/api/etc/usercenter.yaml
```

---

## 批量启动脚本（可选）

创建 `start-all.sh`:

```bash
#!/bin/bash

# 启动所有服务（后台运行）
nohup go run app/usercenter/cmd/rpc/usercenter.go -f app/usercenter/cmd/rpc/etc/usercenter.yaml > logs/usercenter-rpc.log 2>&1 &
nohup go run app/usercenter/cmd/api/usercenter.go -f app/usercenter/cmd/api/etc/usercenter.yaml > logs/usercenter-api.log 2>&1 &

nohup go run app/travel/cmd/rpc/travel.go -f app/travel/cmd/rpc/etc/travel.yaml > logs/travel-rpc.log 2>&1 &
nohup go run app/travel/cmd/api/travel.go -f app/travel/cmd/api/etc/travel.yaml > logs/travel-api.log 2>&1 &

nohup go run app/payment/cmd/rpc/payment.go -f app/payment/cmd/rpc/etc/payment.yaml > logs/payment-rpc.log 2>&1 &
nohup go run app/payment/cmd/api/payment.go -f app/payment/cmd/api/etc/payment.yaml > logs/payment-api.log 2>&1 &

nohup go run app/order/cmd/rpc/order.go -f app/order/cmd/rpc/etc/order.yaml > logs/order-rpc.log 2>&1 &
nohup go run app/order/cmd/api/order.go -f app/order/cmd/api/etc/order.yaml > logs/order-api.log 2>&1 &

echo "所有服务已启动，日志输出到 logs/ 目录"
```

---

## 服务依赖关系

```
usercenter (独立) ✅ 只需要 MySQL + Redis
    ├─ usercenter-rpc
    └─ usercenter-api

travel (独立) ✅ 只需要 MySQL + Redis
    ├─ travel-rpc
    └─ travel-api

payment (独立) ✅ 只需要 MySQL + Redis
    ├─ payment-rpc
    └─ payment-api

order (部分独立)
    ├─ order-rpc ✅ 只需要 MySQL + Redis
    ├─ order-api ✅ 只需要 MySQL + Redis
    └─ order-mq ❌ 需要 Kafka

mqueue ❌ 需要 Kafka
    ├─ mqueue-scheduler
    └─ mqueue-job
```

---

## 推荐启动顺序

**最小化启动（只需 MySQL + Redis）：**

1. 先启动 RPC 服务（被 API 依赖）
2. 再启动 API 服务

```bash
# 步骤1：启动 usercenter-rpc
go run app/usercenter/cmd/rpc/usercenter.go -f app/usercenter/cmd/rpc/etc/usercenter.yaml

# 步骤2：启动 usercenter-api
go run app/usercenter/cmd/api/usercenter.go -f app/usercenter/cmd/api/etc/usercenter.yaml

# 测试
curl http://localhost:1004/user/detail
```

---

## 停止所有服务

```bash
# 查找并停止所有 Go 服务进程
pkill -f "usercenter-rpc"
pkill -f "usercenter-api"
pkill -f "travel-rpc"
pkill -f "travel-api"
pkill -f "payment-rpc"
pkill -f "payment-api"
pkill -f "order-rpc"
pkill -f "order-api"
pkill -f "order-mq"
pkill -f "mqueue"
```

---

## 常见问题

### 1. 端口被占用
```bash
# 查看端口占用
lsof -i :1004
lsof -i :2004

# 杀死占用进程
kill -9 <PID>
```

### 2. 配置文件中的 Jaeger 地址问题
如果没有启动 Jaeger，配置文件中的 `http://jaeger:14268` 会导致启动失败。

**解决方案：**
- 方案A: 注释掉配置文件中的 `Telemetry` 部分
- 方案B: 修改为 `http://localhost:14268`（如果本地有 Jaeger）
- 方案C: 启动 Jaeger: `docker run -d -p 14268:14268 -p 16686:16686 jaegertracing/all-in-one:1.63.0`

### 3. 数据库未初始化
```bash
# 导入数据库
mysql -h127.0.0.1 -P33069 -uroot -pPXDN93VRKUm8TeE7 < deploy/sql/looklook_usercenter.sql
mysql -h127.0.0.1 -P33069 -uroot -pPXDN93VRKUm8TeE7 < deploy/sql/looklook_order.sql
mysql -h127.0.0.1 -P33069 -uroot -pPXDN93VRKUm8TeE7 < deploy/sql/looklook_payment.sql
mysql -h127.0.0.1 -P33069 -uroot -pPXDN93VRKUm8TeE7 < deploy/sql/looklook_travel.sql
```
