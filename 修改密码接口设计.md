# ä¿®æ”¹å¯†ç æ¥å£è®¾è®¡æ–¹æ¡ˆ

> æ—¥æœŸï¼š2025-12-13
> è®¾è®¡è€…ï¼šClaude

---

## ğŸ“‹ éœ€æ±‚åˆ†æ

ç”¨æˆ·éœ€è¦ä¿®æ”¹å¯†ç çš„åœºæ™¯ï¼š
1. **ä¸»åŠ¨ä¿®æ”¹å¯†ç **ï¼šç”¨æˆ·ç™»å½•åï¼Œåœ¨è®¾ç½®ä¸­ä¿®æ”¹å¯†ç ï¼ˆéœ€è¦éªŒè¯æ—§å¯†ç ï¼‰
2. **å¿˜è®°å¯†ç **ï¼šç”¨æˆ·å¿˜è®°å¯†ç ï¼Œé€šè¿‡æ‰‹æœºéªŒè¯ç é‡ç½®ï¼ˆæš‚ä¸å®ç°ï¼Œå¯åç»­æ‰©å±•ï¼‰

---

## ğŸ—„ï¸ æ•°æ®åº“è¡¨åˆ†æ

### ç°æœ‰è¡¨ç»“æ„

**user è¡¨**ï¼š
```sql
id              bigint          PRIMARY KEY AUTO_INCREMENT
mobile          char(11)        NOT NULL UNIQUE    -- æ‰‹æœºå·
password        varchar(255)    NOT NULL           -- å¯†ç ï¼ˆå·²åŠ å¯†ï¼‰
nickname        varchar(255)    NOT NULL
sex             tinyint(1)      DEFAULT 0
avatar          varchar(255)
info            varchar(255)
create_time     datetime        DEFAULT CURRENT_TIMESTAMP
update_time     datetime        DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
delete_time     datetime
del_state       tinyint         DEFAULT 0
version         bigint          DEFAULT 0          -- ä¹è§‚é”ç‰ˆæœ¬å·
```

**user_auth è¡¨**ï¼š
```sql
id              bigint          PRIMARY KEY AUTO_INCREMENT
user_id         bigint          NOT NULL
auth_key        varchar(64)     NOT NULL           -- è®¤è¯é”®ï¼ˆæ‰‹æœºå·ï¼‰
auth_type       varchar(12)     NOT NULL           -- è®¤è¯ç±»å‹ï¼ˆsystemï¼‰
create_time     datetime
update_time     datetime
delete_time     datetime
del_state       tinyint         DEFAULT 0
version         bigint          DEFAULT 0
```

### ç»“è®ºï¼šâœ… ä¸éœ€è¦æ–°å¢å­—æ®µ

- `user.password` å­—æ®µå·²å­˜åœ¨ï¼Œç”¨äºå­˜å‚¨åŠ å¯†åçš„å¯†ç 
- ç°æœ‰å­—æ®µå®Œå…¨æ»¡è¶³ä¿®æ”¹å¯†ç åŠŸèƒ½éœ€æ±‚

---

## ğŸ¯ æ¥å£è®¾è®¡

### æ–¹æ¡ˆä¸€ï¼šä¿®æ”¹å¯†ç ï¼ˆéªŒè¯æ—§å¯†ç ï¼‰ã€æ¨èå®ç°ã€‘

#### 1. æ¥å£åŸºæœ¬ä¿¡æ¯

| é¡¹ç›® | å€¼ |
|------|-----|
| æ¥å£åç§° | ä¿®æ”¹å¯†ç  |
| è·¯å¾„ | `POST /usercenter/v1/user/changePassword` |
| è®¤è¯æ–¹å¼ | JWT Tokenï¼ˆå¿…é¡»ç™»å½•ï¼‰ |
| è¯·æ±‚æ–¹å¼ | POST |
| Content-Type | application/json |

#### 2. è¯·æ±‚å‚æ•°ï¼ˆå…¥å‚ï¼‰

**ChangePasswordReq**

```go
type ChangePasswordReq {
    OldPassword     string `json:"oldPassword"`        // æ—§å¯†ç ï¼ˆæ˜æ–‡ï¼‰
    NewPassword     string `json:"newPassword"`        // æ–°å¯†ç ï¼ˆæ˜æ–‡ï¼‰
    ConfirmPassword string `json:"confirmPassword"`    // ç¡®è®¤æ–°å¯†ç ï¼ˆæ˜æ–‡ï¼‰
}
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ | éªŒè¯è§„åˆ™ |
|------|------|------|------|---------|
| oldPassword | string | æ˜¯ | æ—§å¯†ç  | ä¸èƒ½ä¸ºç©º |
| newPassword | string | æ˜¯ | æ–°å¯†ç  | 6-20ä½ï¼Œå»ºè®®åŒ…å«å­—æ¯å’Œæ•°å­— |
| confirmPassword | string | æ˜¯ | ç¡®è®¤æ–°å¯†ç  | å¿…é¡»ä¸ newPassword ä¸€è‡´ |

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```json
{
    "oldPassword": "123456",
    "newPassword": "abc123456",
    "confirmPassword": "abc123456"
}
```

#### 3. å“åº”å‚æ•°ï¼ˆå‡ºå‚ï¼‰

**ChangePasswordResp**

```go
type ChangePasswordResp {
    // ç©ºç»“æ„ä½“ï¼Œä½¿ç”¨ç»Ÿä¸€å“åº”æ ¼å¼
}
```

**æˆåŠŸå“åº”ç¤ºä¾‹**ï¼š
```json
{
    "code": 200,
    "msg": "å¯†ç ä¿®æ”¹æˆåŠŸ",
    "data": {}
}
```

**å¤±è´¥å“åº”ç¤ºä¾‹**ï¼š
```json
{
    "code": 100001,
    "msg": "æ—§å¯†ç é”™è¯¯",
    "data": null
}
```

#### 4. ä¸šåŠ¡é€»è¾‘æµç¨‹

```
1. éªŒè¯ JWT Tokenï¼Œè·å–å½“å‰ç”¨æˆ·ID
2. å‚æ•°éªŒè¯ï¼š
   - oldPassword ä¸èƒ½ä¸ºç©º
   - newPassword ä¸èƒ½ä¸ºç©ºï¼Œé•¿åº¦ 6-20 ä½
   - confirmPassword å¿…é¡»ä¸ newPassword ä¸€è‡´
   - newPassword ä¸èƒ½ä¸ oldPassword ç›¸åŒ
3. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆæ ¹æ®ç”¨æˆ·IDï¼‰
4. éªŒè¯æ—§å¯†ç æ˜¯å¦æ­£ç¡®ï¼š
   - ä½¿ç”¨ bcrypt æˆ–ç›¸åŒçš„åŠ å¯†æ–¹å¼éªŒè¯
   - å¦‚æœä¸æ­£ç¡®ï¼Œè¿”å›é”™è¯¯ "æ—§å¯†ç é”™è¯¯"
5. åŠ å¯†æ–°å¯†ç ï¼ˆä½¿ç”¨ä¸æ³¨å†Œæ—¶ç›¸åŒçš„åŠ å¯†æ–¹å¼ï¼‰
6. æ›´æ–°æ•°æ®åº“ï¼š
   - æ›´æ–° user.password
   - æ›´æ–° user_auth.auth_keyï¼ˆå¦‚æœå­˜å‚¨çš„æ˜¯å¯†ç ï¼‰
7. è¿”å›æˆåŠŸå“åº”
```

#### 5. é”™è¯¯ç å®šä¹‰

| é”™è¯¯ç  | é”™è¯¯ä¿¡æ¯ | è¯´æ˜ |
|--------|---------|------|
| 200 | å¯†ç ä¿®æ”¹æˆåŠŸ | æˆåŠŸ |
| 100001 | æ—§å¯†ç é”™è¯¯ | æ—§å¯†ç éªŒè¯å¤±è´¥ |
| 100002 | å‚æ•°é”™è¯¯ | å‚æ•°éªŒè¯å¤±è´¥ |
| 100003 | ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´ | confirmPassword ä¸åŒ¹é… |
| 100004 | æ–°å¯†ç ä¸èƒ½ä¸æ—§å¯†ç ç›¸åŒ | é˜²æ­¢æ— æ„ä¹‰ä¿®æ”¹ |
| 100005 | å¯†ç é•¿åº¦å¿…é¡»åœ¨6-20ä½ä¹‹é—´ | å¯†ç æ ¼å¼é”™è¯¯ |
| 100006 | ç”¨æˆ·ä¸å­˜åœ¨ | ç”¨æˆ·IDæ— æ•ˆ |

#### 6. API å®šä¹‰æ–‡ä»¶ï¼ˆuser.apiï¼‰

åœ¨ `app/usercenter/cmd/api/desc/user/user.api` ä¸­æ·»åŠ ï¼š

```go
type (
    ChangePasswordReq {
        OldPassword     string `json:"oldPassword"`        // æ—§å¯†ç 
        NewPassword     string `json:"newPassword"`        // æ–°å¯†ç 
        ConfirmPassword string `json:"confirmPassword"`    // ç¡®è®¤æ–°å¯†ç 
    }
    ChangePasswordResp {
        // ç©ºå“åº”ï¼Œä½¿ç”¨ç»Ÿä¸€æ ¼å¼
    }
)
```

#### 7. ä¸» API æ–‡ä»¶ï¼ˆusercenter.apiï¼‰

åœ¨ `app/usercenter/cmd/api/desc/usercenter.api` çš„ JWT è®¤è¯éƒ¨åˆ†æ·»åŠ ï¼š

```go
//need login
@server(
    prefix: usercenter/v1
    group: user
    jwt: JwtAuth
)
service usercenter {

    @doc "get user info"
    @handler detail
    post /user/detail (UserInfoReq) returns (UserInfoResp)

    @doc "change password"
    @handler changePassword
    post /user/changePassword (ChangePasswordReq) returns (ChangePasswordResp)

    @doc "wechat mini auth"
    @handler wxMiniAuth
    post /user/wxMiniAuth (WXMiniAuthReq) returns (WXMiniAuthResp)
}
```

---

### æ–¹æ¡ˆäºŒï¼šé‡ç½®å¯†ç ï¼ˆçŸ­ä¿¡éªŒè¯ç ï¼‰ã€å¯é€‰ï¼Œåç»­æ‰©å±•ã€‘

#### 1. æ¥å£åŸºæœ¬ä¿¡æ¯

| é¡¹ç›® | å€¼ |
|------|-----|
| æ¥å£åç§° | é‡ç½®å¯†ç  |
| è·¯å¾„ | `POST /usercenter/v1/user/resetPassword` |
| è®¤è¯æ–¹å¼ | æ— éœ€è®¤è¯ï¼ˆé€šè¿‡éªŒè¯ç éªŒè¯ï¼‰ |
| è¯·æ±‚æ–¹å¼ | POST |

#### 2. è¯·æ±‚å‚æ•°

```go
type ResetPasswordReq {
    Mobile          string `json:"mobile"`             // æ‰‹æœºå·
    Code            string `json:"code"`               // çŸ­ä¿¡éªŒè¯ç 
    NewPassword     string `json:"newPassword"`        // æ–°å¯†ç 
    ConfirmPassword string `json:"confirmPassword"`    // ç¡®è®¤æ–°å¯†ç 
}
```

#### 3. å‰ç½®éœ€æ±‚

éœ€è¦å…ˆå®ç°ï¼š
1. å‘é€çŸ­ä¿¡éªŒè¯ç æ¥å£
2. éªŒè¯ç å­˜å‚¨ï¼ˆRedisï¼‰
3. éªŒè¯ç éªŒè¯é€»è¾‘

**å»ºè®®**ï¼šæš‚ä¸å®ç°ï¼Œç­‰åŸºç¡€çš„ä¿®æ”¹å¯†ç åŠŸèƒ½ç¨³å®šåå†æ‰©å±•ã€‚

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. å¯†ç åŠ å¯†

```go
// ä½¿ç”¨ bcrypt åŠ å¯†å¯†ç ï¼ˆæ¨èï¼‰
import "golang.org/x/crypto/bcrypt"

// åŠ å¯†
hashedPassword, _ := bcrypt.GenerateFromPassword([]byte(password), bcrypt.DefaultCost)

// éªŒè¯
err := bcrypt.CompareHashAndPassword([]byte(hashedPassword), []byte(password))
```

### 2. å¯†ç è§„åˆ™éªŒè¯

```go
// å¯†ç é•¿åº¦
if len(newPassword) < 6 || len(newPassword) > 20 {
    return errors.New("å¯†ç é•¿åº¦å¿…é¡»åœ¨6-20ä½ä¹‹é—´")
}

// æ¨èï¼šå¯†ç å¼ºåº¦éªŒè¯ï¼ˆå¯é€‰ï¼‰
// - è‡³å°‘åŒ…å«ä¸€ä¸ªå­—æ¯
// - è‡³å°‘åŒ…å«ä¸€ä¸ªæ•°å­—
// - å¯ä»¥åŒ…å«ç‰¹æ®Šå­—ç¬¦
```

### 3. é˜²æ­¢æš´åŠ›ç ´è§£

```go
// ä½¿ç”¨ Redis è®°å½•å¤±è´¥æ¬¡æ•°
// key: change_password_fail:{user_id}
// å¤±è´¥è¶…è¿‡ 5 æ¬¡ï¼Œé”å®š 30 åˆ†é’Ÿ
```

### 4. æ—¥å¿—è®°å½•

```go
// è®°å½•å¯†ç ä¿®æ”¹æ“ä½œ
logger.Info("ç”¨æˆ·ä¿®æ”¹å¯†ç ",
    zap.Int64("userId", userId),
    zap.String("ip", ip),
    zap.Time("time", time.Now()))
```

---

## ğŸ“ å®ç°æ­¥éª¤

### Step 1: ä¿®æ”¹ API å®šä¹‰æ–‡ä»¶

```bash
# ç¼–è¾‘æ–‡ä»¶
vim app/usercenter/cmd/api/desc/user/user.api
vim app/usercenter/cmd/api/desc/usercenter.api
```

### Step 2: ç”Ÿæˆä»£ç 

```bash
cd app/usercenter/cmd/api
goctl api go -api desc/usercenter.api -dir .
```

è¿™ä¼šè‡ªåŠ¨ç”Ÿæˆï¼š
- `internal/handler/user/changePasswordHandler.go`
- `internal/logic/user/changePasswordLogic.go`
- `internal/types/types.go`ï¼ˆæ›´æ–°ï¼‰

### Step 3: å®ç°ä¸šåŠ¡é€»è¾‘

åœ¨ `internal/logic/user/changePasswordLogic.go` ä¸­å®ç°ï¼š

```go
func (l *ChangePasswordLogic) ChangePassword(req *types.ChangePasswordReq) (resp *types.ChangePasswordResp, err error) {
    // 1. è·å–å½“å‰ç”¨æˆ·IDï¼ˆä» JWT tokenï¼‰
    userId := ctxdata.GetUidFromCtx(l.ctx)

    // 2. å‚æ•°éªŒè¯
    if req.NewPassword != req.ConfirmPassword {
        return nil, xerr.NewErrMsg("ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´")
    }

    if req.NewPassword == req.OldPassword {
        return nil, xerr.NewErrMsg("æ–°å¯†ç ä¸èƒ½ä¸æ—§å¯†ç ç›¸åŒ")
    }

    if len(req.NewPassword) < 6 || len(req.NewPassword) > 20 {
        return nil, xerr.NewErrMsg("å¯†ç é•¿åº¦å¿…é¡»åœ¨6-20ä½ä¹‹é—´")
    }

    // 3. è°ƒç”¨ RPC ä¿®æ”¹å¯†ç 
    _, err = l.svcCtx.UsercenterRpc.ChangePassword(l.ctx, &pb.ChangePasswordReq{
        UserId:      userId,
        OldPassword: req.OldPassword,
        NewPassword: req.NewPassword,
    })

    if err != nil {
        return nil, err
    }

    return &types.ChangePasswordResp{}, nil
}
```

### Step 4: RPC å±‚å®ç°

åœ¨ `app/usercenter/cmd/rpc` ä¸­ï¼š

1. ä¿®æ”¹ `pb/usercenter.proto`
2. ç”Ÿæˆ RPC ä»£ç 
3. å®ç° `internal/logic/changePasswordLogic.go`

### Step 5: æµ‹è¯•

```bash
# 1. ç™»å½•è·å– token
TOKEN=$(curl -s -X POST http://localhost:1004/usercenter/v1/user/login \
  -H "Content-Type: application/json" \
  -d '{"mobile":"13900139002","password":"123456"}' | \
  jq -r '.data.accessToken')

# 2. ä¿®æ”¹å¯†ç 
curl -X POST http://localhost:1004/usercenter/v1/user/changePassword \
  -H "Content-Type: application/json" \
  -H "Authorization: $TOKEN" \
  -d '{
    "oldPassword": "123456",
    "newPassword": "abc123456",
    "confirmPassword": "abc123456"
  }'
```

---

## ğŸ“Š æ•°æ®åº“æ“ä½œ

### æ›´æ–°è¯­å¥

```sql
UPDATE looklook_usercenter.user
SET password = ?,
    update_time = NOW()
WHERE id = ?
  AND del_state = 0;

-- å¦‚æœ user_auth è¡¨ä¹Ÿå­˜å‚¨å¯†ç ï¼Œä¹Ÿéœ€è¦æ›´æ–°
UPDATE looklook_usercenter.user_auth
SET auth_key = ?,
    update_time = NOW()
WHERE user_id = ?
  AND auth_type = 'system'
  AND del_state = 0;
```

---

## âœ… æ€»ç»“

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | æ“ä½œ |
|------|------|
| `app/usercenter/cmd/api/desc/user/user.api` | æ·»åŠ è¯·æ±‚/å“åº”ç±»å‹ |
| `app/usercenter/cmd/api/desc/usercenter.api` | æ·»åŠ æ¥å£è·¯ç”± |
| `app/usercenter/cmd/api/internal/logic/user/changePasswordLogic.go` | å®ç°ä¸šåŠ¡é€»è¾‘ |
| `app/usercenter/cmd/rpc/pb/usercenter.proto` | æ·»åŠ  RPC æ¥å£ |
| `app/usercenter/cmd/rpc/internal/logic/changePasswordLogic.go` | å®ç° RPC é€»è¾‘ |

### æ˜¯å¦éœ€è¦æ–°å¢æ•°æ®åº“å­—æ®µï¼Ÿ

**âŒ ä¸éœ€è¦**

ç†ç”±ï¼š
- `user.password` å­—æ®µå·²å­˜åœ¨ï¼Œå¯ç›´æ¥æ›´æ–°
- `user.update_time` ä¼šè‡ªåŠ¨æ›´æ–°ï¼ˆON UPDATE CURRENT_TIMESTAMPï¼‰
- ç°æœ‰å­—æ®µå®Œå…¨æ»¡è¶³éœ€æ±‚

### ä¼˜å…ˆçº§å»ºè®®

1. **å…ˆå®ç°**ï¼šæ–¹æ¡ˆä¸€ï¼ˆé€šè¿‡æ—§å¯†ç ä¿®æ”¹ï¼‰âœ…
   - æœ€å¸¸ç”¨çš„åŠŸèƒ½
   - å®ç°ç®€å•
   - å®‰å…¨æ€§é«˜

2. **åç»­æ‰©å±•**ï¼šæ–¹æ¡ˆäºŒï¼ˆçŸ­ä¿¡éªŒè¯ç é‡ç½®ï¼‰
   - éœ€è¦çŸ­ä¿¡æœåŠ¡
   - éœ€è¦éªŒè¯ç æœºåˆ¶
   - å®ç°å¤æ‚åº¦è¾ƒé«˜

---

## ğŸ“ éœ€è¦æˆ‘å¸®æ‚¨å®ç°å—ï¼Ÿ

å¦‚æœéœ€è¦ï¼Œæˆ‘å¯ä»¥ï¼š
1. âœ… ä¿®æ”¹ API å®šä¹‰æ–‡ä»¶
2. âœ… ç”Ÿæˆä»£ç æ¡†æ¶
3. âœ… å®ç°å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘
4. âœ… ç¼–å†™æµ‹è¯•è„šæœ¬

è¯·å‘Šè¯‰æˆ‘æ˜¯å¦å¼€å§‹å®ç°ï¼
